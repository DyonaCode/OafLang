name: run-cross-platform-tests

on:
  workflow_dispatch:

jobs:
  dotnet-tests:
    name: Dotnet Self-Test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os:
          - ubuntu-latest
          - macos-latest
          - windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Restore
        run: dotnet restore

      - name: Build
        run: dotnet build --configuration Release --no-restore

      - name: Run self-test suite
        shell: bash
        run: dotnet run --configuration Release -- --self-test | tee self-test-output.txt

      - name: Summarize parity checks
        if: always()
        shell: bash
        run: bash scripts/ci/append_parity_summary.sh self-test-output.txt "${{ matrix.os }}"

  c-runtime-smoke:
    name: C Runtime Smoke (ubuntu)
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Configure CMake
        run: cmake -S . -B build -DCMAKE_BUILD_TYPE=Release

      - name: Build runtime and smoke tests
        run: cmake --build build --config Release

      - name: Execute smoke binaries
        run: |
          run_smoke() {
            local new_name="$1"
            local old_name="$2"
            if [[ -x "./build/${new_name}" ]]; then
              "./build/${new_name}"
              return
            fi
            if [[ -x "./build/${old_name}" ]]; then
              "./build/${old_name}"
              return
            fi
            echo "Missing smoke binary: ./build/${new_name} (or ./build/${old_name})" >&2
            ls -la ./build >&2 || true
            exit 1
          }

          run_smoke oaf_error_smoke oaflang_error_smoke
          run_smoke oaf_memory_smoke oaflang_memory_smoke
          run_smoke oaf_runtime_smoke oaflang_runtime_smoke
          run_smoke oaf_types_smoke oaflang_types_smoke
          run_smoke oaf_concurrency_smoke oaflang_concurrency_smoke
          run_smoke oaf_ffi_smoke oaflang_ffi_smoke
          run_smoke oaf_collections_smoke oaflang_collections_smoke
          run_smoke oaf_stdlib_smoke oaflang_stdlib_smoke
          run_smoke oaf_advanced_concurrency_smoke oaflang_advanced_concurrency_smoke
