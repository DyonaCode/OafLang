name: build-and-create-release

on:
  push:
    tags:
      - "v*"
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (with or without leading v)"
        required: true
        type: string

permissions:
  contents: read

jobs:
  resolve_version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.resolve.outputs.version }}
      tag: ${{ steps.resolve.outputs.tag }}
    steps:
      - name: Resolve release version
        id: resolve
        run: |
          if [[ "${GITHUB_EVENT_NAME}" == "push" ]]; then
            raw_version="${GITHUB_REF_NAME}"
          else
            raw_version="${{ github.event.inputs.version }}"
          fi

          version="${raw_version#v}"

          if [[ -z "${version}" ]]; then
            echo "Version is required." >&2
            exit 1
          fi

          echo "version=${version}" >> "${GITHUB_OUTPUT}"
          echo "tag=v${version}" >> "${GITHUB_OUTPUT}"

  build_artifacts:
    needs: resolve_version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: ubuntu-latest
            runtime_id: linux-x64
          - os: macos-latest
            runtime_id: osx-arm64
          - os: windows-latest
            runtime_id: win-x64
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Build package (Unix)
        if: runner.os != 'Windows'
        run: |
          bash scripts/release/create_package.sh "${{ needs.resolve_version.outputs.version }}" "${{ matrix.runtime_id }}"

      - name: Validate packaged examples (Unix)
        if: runner.os != 'Windows'
        run: |
          set -euo pipefail
          version="${{ needs.resolve_version.outputs.version }}"
          archive="dist/oaf-${version}.tar.gz"
          temp_dir="$(mktemp -d)"
          trap 'rm -rf "${temp_dir}"' EXIT

          tar -xzf "${archive}" -C "${temp_dir}"
          package_root="${temp_dir}/oaf-${version}"
          cli="${package_root}/bin/oaf"

          "${cli}" test "${package_root}/examples" -r vm --compilation-target bytecode
          "${cli}" test "${package_root}/examples" -r vm --compilation-target mlir

      - name: Validate scaffold workflow (Unix)
        if: runner.os != 'Windows'
        run: |
          set -euo pipefail
          version="${{ needs.resolve_version.outputs.version }}"
          archive="dist/oaf-${version}.tar.gz"
          temp_dir="$(mktemp -d)"
          trap 'rm -rf "${temp_dir}"' EXIT

          tar -xzf "${archive}" -C "${temp_dir}"
          package_root="${temp_dir}/oaf-${version}"
          cli="${package_root}/bin/oaf"
          project_dir="${temp_dir}/scaffold-smoke"

          "${cli}" new "${project_dir}"
          "${cli}" test "${project_dir}" -r vm --compilation-target bytecode
          "${cli}" build "${project_dir}/main.oaf" -o "${project_dir}/.oaf/build"
          "${cli}" publish "${project_dir}/main.oaf" -o "${project_dir}/.oaf/publish"

      - name: Validate installer and version shim (Unix)
        if: runner.os != 'Windows'
        run: |
          set -euo pipefail
          version="${{ needs.resolve_version.outputs.version }}"
          archive="dist/oaf-${version}.tar.gz"
          temp_dir="$(mktemp -d)"
          trap 'rm -rf "${temp_dir}"' EXIT

          tar -xzf "${archive}" -C "${temp_dir}"
          package_root="${temp_dir}/oaf-${version}"
          temp_home="${temp_dir}/home"
          install_dir="${temp_dir}/bin"
          oaf_home="${temp_dir}/oaf-home"
          mkdir -p "${temp_home}"

          HOME="${temp_home}" OAF_INSTALL_DIR="${install_dir}" OAF_HOME="${oaf_home}" \
            "${package_root}/install.sh" "${version}"

          env PATH="${install_dir}:${PATH}" HOME="${temp_home}" OAF_HOME="${oaf_home}" oaf --version
          env PATH="${install_dir}:${PATH}" HOME="${temp_home}" OAF_HOME="${oaf_home}" oaf version
          env PATH="${install_dir}:${PATH}" HOME="${temp_home}" OAF_HOME="${oaf_home}" oaf version "${version}"

      - name: Rename package archives (Unix)
        if: runner.os != 'Windows'
        run: |
          version="${{ needs.resolve_version.outputs.version }}"
          runtime_id="${{ matrix.runtime_id }}"
          for ext in tar.gz zip; do
            src="dist/oaf-${version}.${ext}"
            dst="dist/oaf-${version}-${runtime_id}.${ext}"
            if [[ -f "${src}" ]]; then
              mv "${src}" "${dst}"
            fi
          done

      - name: Build package (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          ./scripts/release/create_package.ps1 -Version "${{ needs.resolve_version.outputs.version }}" -RuntimeId "${{ matrix.runtime_id }}"

      - name: Validate packaged examples (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ needs.resolve_version.outputs.version }}"
          $archive = "dist/oaf-$version.zip"
          $tempDir = Join-Path $env:RUNNER_TEMP ("oaf_pkg_validate_" + [Guid]::NewGuid().ToString("N"))
          New-Item -ItemType Directory -Path $tempDir | Out-Null
          try {
            Expand-Archive -Path $archive -DestinationPath $tempDir -Force
            $packageRoot = Join-Path $tempDir "oaf-$version"
            $cli = Join-Path $packageRoot "bin/oaf.exe"

            & $cli test (Join-Path $packageRoot "examples") -r vm --compilation-target bytecode
            if ($LASTEXITCODE -ne 0) {
              throw "Packaged examples failed for bytecode target."
            }

            & $cli test (Join-Path $packageRoot "examples") -r vm --compilation-target mlir
            if ($LASTEXITCODE -ne 0) {
              throw "Packaged examples failed for MLIR target."
            }
          }
          finally {
            if (Test-Path $tempDir) {
              Remove-Item -Path $tempDir -Recurse -Force
            }
          }

      - name: Validate scaffold workflow (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ needs.resolve_version.outputs.version }}"
          $archive = "dist/oaf-$version.zip"
          $tempDir = Join-Path $env:RUNNER_TEMP ("oaf_scaffold_validate_" + [Guid]::NewGuid().ToString("N"))
          New-Item -ItemType Directory -Path $tempDir | Out-Null
          try {
            Expand-Archive -Path $archive -DestinationPath $tempDir -Force
            $packageRoot = Join-Path $tempDir "oaf-$version"
            $cli = Join-Path $packageRoot "bin/oaf.exe"
            $projectDir = Join-Path $tempDir "scaffold-smoke"

            & $cli new $projectDir
            if ($LASTEXITCODE -ne 0) { throw "oaf new failed." }

            & $cli test $projectDir -r vm --compilation-target bytecode
            if ($LASTEXITCODE -ne 0) { throw "oaf test failed." }

            & $cli build (Join-Path $projectDir "main.oaf") -o (Join-Path $projectDir ".oaf/build")
            if ($LASTEXITCODE -ne 0) { throw "oaf build failed." }

            & $cli publish (Join-Path $projectDir "main.oaf") -o (Join-Path $projectDir ".oaf/publish")
            if ($LASTEXITCODE -ne 0) { throw "oaf publish failed." }
          }
          finally {
            if (Test-Path $tempDir) {
              Remove-Item -Path $tempDir -Recurse -Force
            }
          }

      - name: Validate installer and version shim (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ needs.resolve_version.outputs.version }}"
          $archive = "dist/oaf-$version.zip"
          $tempDir = Join-Path $env:RUNNER_TEMP ("oaf_installer_validate_" + [Guid]::NewGuid().ToString("N"))
          New-Item -ItemType Directory -Path $tempDir | Out-Null
          try {
            Expand-Archive -Path $archive -DestinationPath $tempDir -Force
            $packageRoot = Join-Path $tempDir "oaf-$version"
            $installDir = Join-Path $tempDir "bin"
            $oafHome = Join-Path $tempDir "oaf-home"
            $shim = Join-Path $installDir "oaf.cmd"

            try {
              & (Join-Path $packageRoot "install.ps1") -InstallDir $installDir -OafHome $oafHome -Version $version
            }
            catch {
              throw "Installer failed: $($_.Exception.Message)"
            }

            & $shim --version
            if ($LASTEXITCODE -ne 0) {
              throw "Shim --version failed."
            }

            & $shim version
            if ($LASTEXITCODE -ne 0) {
              throw "Shim version listing failed."
            }

            & $shim version $version
            if ($LASTEXITCODE -ne 0) {
              throw "Shim version selection failed."
            }
          }
          finally {
            if (Test-Path $tempDir) {
              Remove-Item -Path $tempDir -Recurse -Force
            }
          }

      - name: Rename package archives (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $version = "${{ needs.resolve_version.outputs.version }}"
          $runtime = "${{ matrix.runtime_id }}"
          $src = "dist/oaf-$version.zip"
          $dst = "dist/oaf-$version-$runtime.zip"
          if (Test-Path $src) {
            Move-Item -Path $src -Destination $dst -Force
          }

      - name: Upload artifact bundle
        uses: actions/upload-artifact@v4
        with:
          name: release-${{ matrix.runtime_id }}
          path: dist/oaf-${{ needs.resolve_version.outputs.version }}-${{ matrix.runtime_id }}.*
          if-no-files-found: error

  reproducibility_check:
    needs: resolve_version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 10.0.x

      - name: Run reproducibility check (linux-x64)
        run: |
          bash scripts/release/check_reproducibility.sh "${{ needs.resolve_version.outputs.version }}" linux-x64 --strict

  publish_release:
    needs:
      - resolve_version
      - build_artifacts
      - reproducibility_check
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Download built artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: release-*
          path: release-artifacts
          merge-multiple: true

      - name: Generate SHA256 checksums
        run: |
          set -euo pipefail
          cd release-artifacts
          shopt -s nullglob
          files=(oaf-*)
          if [[ ${#files[@]} -eq 0 ]]; then
            echo "No release artifacts found." >&2
            exit 1
          fi
          sha256sum "${files[@]}" > SHA256SUMS.txt

      - name: Create GitHub release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.resolve_version.outputs.tag }}
          name: Oaf v${{ needs.resolve_version.outputs.version }}
          target_commitish: ${{ github.sha }}
          generate_release_notes: true
          files: release-artifacts/*
